<?php $__env->startSection('head'); ?> <?php $__env->stopSection(); ?>
<?php $__env->startSection('encabezado'); ?> PAGOS <?php $__env->stopSection(); ?>
<?php $__env->startSection('encabezado_descripcion'); ?> Nuevo pago <?php $__env->stopSection(); ?> 
<?php $__env->startSection('nivel'); ?> <li><a href="<?php echo URL::to('pagos'); ?>"><i class="fa fa-money"></i> pagos</a></li>
            <li class="active">Nuevo</li><?php $__env->stopSection(); ?>
<?php $__env->startSection('content'); ?>

<?php echo Former::framework('TwitterBootstrap3'); ?>



<div class="box">
  <div class="box-header with-border">
    <h3 class="box-title">Nuevo Pago</h3>
    <div class="box-tools pull-right">
      <!-- Buttons, labels, and many other things can be placed here! -->
      <!-- Here is a label for example -->
      <span class="label label-primary"></span>
    </div><!-- /.box-tools -->
  </div><!-- /.box-header -->
  <div class="box-body">
   		<?php echo Former::open('pagos')->addClass('col-md-10 col-md-offset-1 warn-on-exit')->method('post')->rules(array(
			'client' => 'required',
			'invoice' => 'required',		
			'amount' => 'required|Numeric',		
		));; ?>

	
		<div class="row">
			<div class="col-md-10">

				<?php echo Former::select('client')->addOption('', '')->label('Cliente')->fromQuery(Client::where('account_id',Auth::user()->account_id)->get(),'name')->id('client_id'); ?>

				<?php echo Former::select('invoice')->addOption('', '')->label('Factura')->id('invoice_select'); ?>

				<?php echo Former::text('amount')->label('Monto')->title('Solo se acepta nÃºmeros.')->id('amount'); ?>

				<?php echo Former::select('payment_type_id')->label('Tipo de Pago')->fromQuery(PaymentType::all(), 'name', 'id'); ?>			
				<?php echo Former::text('payment_date')->label('Fecha de Pago')->append('<i class="glyphicon glyphicon-calendar"></i>')->id('date'); ?>

				 <?php /* <input class="form-control pull-right" name="payment_date" id="date" type="text" placeholder="Fecha de Pago"  required> */ ?>
				<?php echo Former::text('transaction_reference')->label('Referencia de Pago')->placeholder('Pago realizado'); ?>


			</div>
		</div>

		<center class="buttons">

			<a href="<?php echo url('pagos/'); ?>" class="btn btn-default"> Cancelar </a>
	    	<button type="submit" class="btn btn-success dropdown-toggle"> Guardar </button>

		</center>

		<?php echo Former::close(); ?>

  </div><!-- /.box-body -->
  <div class="box-footer">
    
  </div><!-- box-footer -->
</div><!-- /.box -->

<script type="text/javascript">

	// window.facturas;
	window.facturas=null;
	
	$("#date").datepicker();
	$('#date').on('changeDate', function(ev){
            $(this).datepicker('hide');
        });
	$('#client_id').change(function(){
		// console.log('entro aqui');
		if(this.value)
		{
			$.ajax({url: '<?php echo URL::to("pago/factura/'+this.value+'"); ?>', success: function(result){
		        
		        facturas = result;
		        console.log(facturas);
		        //limpiando
		        $('#invoice_select')
				    .empty()
				    .append('<option selected="selected" value=""></option>');
				 $('#amount').val('');
				//poblando
		        for (var i = 0; i< result.length; i++) {
		        	$('#invoice_select').append('<option value='+result[i].id+'> Factura #'+result[i].invoice_number+' Importe Total '+result[i].importe_total+' ('+result[i].balance+')</option>');
		        	// console.log("Imprimiendo elemento"+i);
		        	// console.log(result[i].id);	
		        };
		        // console.log(result);

   			 }});
		}
                if($("#payment_type_id").val() == 2){
                $.ajax({url: '<?php echo URL::to("pago/factura/credit/'+$('#client_id').val()+'"); ?>', success: function(result){
                max_credit = result;
                }});
                }
		 console.log(facturas);
				// console.log(facturas);

	});
	$('#invoice_select').change(function(){
		// console.log('entro aqui');
		if(this.value)
		{
			 for (var i = 0; i< facturas.length; i++) {
			 	console.log('comparando '+this.value+' con '+facturas[i].id);
			 	if(this.value==facturas[i].id)
			 	{
			 		console.log('elemento encontrado'+facturas[i].balance);
			 		
			 		$('#amount').val(facturas[i].balance);
			 		i=facturas.length;
			 	}
			 }
		}
		 console.log(facturas);
				// console.log(facturas);

	});
        max_credit = 0;
//        $('#payment_type_id').change(function(){
//            if(this.value == 2){
//                $.ajax({url: '<?php echo URL::to("pago/factura/credit/'+$('#client_id').val()+'"); ?>', success: function(result){
//                max_credit = result;
//                console.log("<<<<<"+result);
//            }});
//            }
//        });
        
//        $("#amount").change(function(){        
//        
//            if ($(this).val() > max_credit && $("#payment_type_id").val()==2)
//            {            
//              $(this).val(max_credit);
//            }
//            str = $("#invoice_select").text();
//            ind1=str.indexOf('(');
//            ind2=str.indexOf(')');
//            num=str.substr(ind1+1,ind2-ind1-1);            
//            if($(this).val() > num)
//                $(this).val(num);
//        });
        
        
	
</script>


<?php $__env->stopSection(); ?>

<?php echo $__env->make('header', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>